#!/usr/bin/env bash

set -ex

. /home/user/env/bin/activate
. ci/install-inplace webdav

ROOT="$HOME/wildland"
STORAGE="/home/user/storage"
MNT_DIR_1="webdav-mnt-1"
MNT_DIR_2="webdav-mnt-2"
MNT_PATH_1="$ROOT/$MNT_DIR_1"
MNT_PATH_2="$ROOT/$MNT_DIR_2"
CATEGORY_PATH_1="$ROOT/ci-test"

# Setup
mkdir -p "$STORAGE"
sudo /etc/init.d/apache2 start

mkdir -p "$STORAGE"/foo
echo foobar > "$STORAGE"/foo/file1.txt
echo text > "$STORAGE"/file2.txt

WL='python3 -m coverage run -p ./wl'

# Wildland
$WL --debug --verbose user create User1
$WL --debug --verbose container create Container1 --path "/$MNT_DIR_1" \
                                 --category /ci-test
$WL --debug --verbose storage create webdav --container Container1 \
                           --login 'user' \
                           --password 'password' \
                           --url 'http://localhost:8081/'
$WL --debug --verbose start

# Test files and directories
tree $ROOT
time -p test -f "$CATEGORY_PATH_1"/Container1/file2.txt
time -p chronic grep 'text' "$CATEGORY_PATH_1"/Container1/file2.txt
time -p test -f "$MNT_PATH_1"/file2.txt
time -p chronic grep 'text' "$MNT_PATH_1"/file2.txt

time -p test -d "$CATEGORY_PATH_1"/Container1/foo
time -p test -d "$MNT_PATH_1"/foo

time -p test -f "$CATEGORY_PATH_1"/Container1/foo/file1.txt
time -p chronic grep 'foobar' "$CATEGORY_PATH_1"/Container1/foo/file1.txt
time -p test -f "$MNT_PATH_1"/foo/file1.txt
time -p chronic grep 'foobar' "$MNT_PATH_1"/foo/file1.txt

# Cleanup
rm -rf "$STORAGE"

# Test template creation
$WL --debug --verbose template create webdav --login 'user' \
                            --password 'password' \
                            --url 'http://localhost:8081/' webdav-temp
$WL --debug --verbose container create webdav-temp --template webdav-temp --path "/$MNT_DIR_2"
$WL --debug --verbose container mount webdav-temp

# Verify the template creation works
tree "$MNT_PATH_2"

$WL --debug --verbose stop
